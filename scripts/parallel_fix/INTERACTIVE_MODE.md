# 交互式模式使用指南

交互式模式允许你在系统自动发送初始prompt后，继续与Claude进行多轮对话，适合需要深入讨论和逐步调整的复杂修复任务。

## 快速开始

```bash
# 基本用法
./scripts/parallel_fix/run.sh --interactive tasks.json

# 或使用短选项
./scripts/parallel_fix/run.sh -i tasks.json

# 配合其他选项
./scripts/parallel_fix/run.sh -i --difficulty hard tasks.json
```

## 工作流程

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 系统加载任务文件                                            │
│    - 只处理第一个任务                                          │
│    - 显示任务信息和难度配置                                     │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. 自动生成并发送初始prompt                                    │
│    - 根据任务类型生成专业prompt                                │
│    - 包含错误模式、修复方案、完成协议                           │
│    - 显示prompt预览（前50行）                                  │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. Claude开始处理并响应                                        │
│    - 使用配置的模型（根据难度）                                │
│    - 自动启用思考模式（hard难度）                              │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. 你可以继续输入                                              │
│    ✓ 追问细节                                                 │
│    ✓ 调整修复方案                                             │
│    ✓ 请求解释                                                 │
│    ✓ 逐步验证                                                 │
│    ✓ 探索其他方案                                             │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. 完成并退出                                                  │
│    - Ctrl+D 或输入 exit 退出                                  │
│    - 系统记录完整对话日志                                      │
└─────────────────────────────────────────────────────────────┘
```

## 适用场景

### ✅ 推荐使用交互模式

1. **复杂语法错误**
   - 括号不匹配、模板展开错误
   - 需要理解代码结构

2. **重构任务**
   - 跨文件依赖
   - API迁移需要多处协调

3. **学习和理解**
   - 想要理解错误原因
   - 学习最佳修复方案

4. **不确定性高的任务**
   - 需要多种方案对比
   - 需要逐步验证

### ❌ 不推荐使用交互模式

1. **简单重复任务**
   - 缺少头文件
   - 简单的类型转换

2. **明确的机械替换**
   - API名称变更
   - 参数顺序调整

3. **批量处理**
   - 多个文件相同错误
   - 使用并行模式更高效

## 使用示例

### 示例 1: 处理复杂语法错误

```bash
# 1. 创建任务文件
cat > task.json << 'EOF'
{
  "tasks": [{
    "id": "1",
    "type": "syntax",
    "files": ["src/complex.hpp"],
    "description": "修复复杂的模板语法错误",
    "difficulty": "hard"
  }]
}
EOF

# 2. 启动交互模式
./scripts/parallel_fix/run.sh -i task.json

# 3. 系统自动发送初始prompt后，你可以：

# 追问细节
> 能详细解释一下第123行的错误原因吗？

# 请求多种方案
> 除了这个修复方案，还有其他更简洁的方法吗？

# 逐步验证
> 先修复第一个错误，我验证一下再继续

# 调整策略
> 这个改动太大了，能保持原有结构吗？
```

### 示例 2: 一键交互式修复

```bash
# 使用quick_fix.sh的交互模式
./scripts/parallel_fix/quick_fix.sh --interactive

# 完整流程：
# 1. 自动编译捕获错误
# 2. 分析生成任务
# 3. 进入交互模式处理第一个任务
```

### 示例 3: 指定难度的交互式修复

```bash
# 使用最强模型 + 思考模式
./scripts/parallel_fix/run.sh -i --difficulty hard tasks.json

# 配置中的 hard 设置：
# - Model: claude-opus-4-5-20251101
# - Think: true
# - Max tokens: 32768
```

## 交互技巧

### 有效的追问方式

**✅ 好的追问：**
```
- "能解释一下为什么这个错误会发生吗？"
- "这个修复会影响其他文件吗？"
- "能给出一个更保守的修复方案吗？"
- "让我先验证第一部分，然后再继续"
```

**❌ 避免的追问：**
```
- "继续" （太模糊）
- "然后呢？" （缺少上下文）
- "改吧" （没有具体指示）
```

### 常用对话模式

```bash
# 1. 理解错误
You: 先不要修复，解释一下这些错误的根本原因

# 2. 评估方案
You: 这个方案的优缺点是什么？有没有其他选择？

# 3. 分步执行
You: 先修复第一个文件，我测试通过后再修复其他文件

# 4. 调整方向
You: 这个改动太激进了，能否只做最小必要修改？

# 5. 深入细节
You: 第123行的模板展开错误能详细说明吗？
```

## 日志和状态

### 日志位置

```bash
# 完整对话日志
.parallel_fix_state/logs/task_1.log

# 包含：
# - 初始prompt
# - Claude的响应
# - 你的追问
# - 所有后续对话
```

### 状态管理

交互模式完成后，系统会自动更新任务状态：

```bash
# 查看状态
cat .parallel_fix_state/status

# 格式：
# task_id:status:timestamp:message
# 1:completed:2024-12-29T10:30:00:交互会话完成
```

### 手动更新状态

如果需要手动标记任务完成（在交互中已完成修复）：

```bash
# 在Claude对话中执行
echo "1:completed:$(date -Is):修复完成" >> .parallel_fix_state/status
```

## 与非交互模式对比

| 特性 | 交互模式 | 并行模式 |
|------|---------|---------|
| 任务数 | 只处理第一个 | 并行处理全部 |
| 对话 | 多轮交互 | 单次执行 |
| 适用 | 复杂/不确定任务 | 明确/重复任务 |
| 效率 | 深度 > 速度 | 速度 > 深度 |
| 控制 | 手动控制流程 | 自动批量处理 |
| 学习 | 高（可深入探讨） | 低（快速完成） |

## 常见问题

### Q: 交互模式下如何退出？

A: 使用 `Ctrl+D` 或输入特定退出命令（取决于Claude CLI实现）。

### Q: 可以同时交互处理多个任务吗？

A: 不可以。交互模式只处理第一个任务。要处理多个，需要：
```bash
# 方案1: 依次交互
./run.sh -i task1.json
./run.sh -i task2.json

# 方案2: 第一个交互，其余并行
./run.sh -i task1.json  # 交互
./run.sh task_rest.json  # 并行
```

### Q: 交互模式的日志在哪里？

A: `.parallel_fix_state/logs/task_N.log` 包含完整对话记录。

### Q: 交互中修复完成后需要手动标记状态吗？

A: 通常不需要。退出时系统会自动标记。如果需要手动标记，参考上面的"手动更新状态"部分。

### Q: 可以在交互中切换难度吗？

A: 不可以。难度在启动时确定。要更改难度，需要退出后用新难度重启。

## 最佳实践

1. **先预览任务**
   ```bash
   ./run.sh --dry-run tasks.json  # 查看会发送什么prompt
   ```

2. **复杂任务用hard模式**
   ```bash
   ./run.sh -i --difficulty hard tasks.json
   ```

3. **保存对话记录**
   ```bash
   # 日志自动保存，可以后续查看
   cat .parallel_fix_state/logs/task_1.log
   ```

4. **分解大任务**
   - 如果任务涉及多个文件
   - 先交互处理最复杂的
   - 然后并行处理其余的

5. **利用上下文**
   - Claude会记住整个对话
   - 可以引用之前的讨论
   - "按照刚才的方案2执行"

