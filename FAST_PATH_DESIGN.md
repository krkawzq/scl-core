# å¿«é€Ÿè·¯å¾„è®¾è®¡æ–‡æ¡£

## è®¾è®¡ç†å¿µ

**æŠ½è±¡ä¸æ€»æ˜¯å¥½çš„** - å¿…è¦æ—¶ä¸ºç‰¹å®šæ•°æ®ç»“æ„æä¾›ä¼˜åŒ–è·¯å¾„

### ä¸¤å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Generic Path (AnySparse)               â”‚
â”‚  - é€‚ç”¨äºæ‰€æœ‰ç¨€ç–çŸ©é˜µç±»å‹                â”‚
â”‚  - ä½¿ç”¨ç»Ÿä¸€è®¿é—®å™¨                        â”‚
â”‚  - é›¶ä»£ç é‡å¤                            â”‚
â”‚  - æ€§èƒ½: åŸºå‡†                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ è‡ªåŠ¨é€‰æ‹©
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Fast Path (CustomSparseLike)           â”‚
â”‚  - ä»…ç”¨äºè¿ç»­å­˜å‚¨ç±»å‹                    â”‚
â”‚  - ç›´æ¥è®¿é—® data/indices/indptr          â”‚
â”‚  - æ‰¹é‡SIMDæ“ä½œ                          â”‚
â”‚  - æ€§èƒ½: 2-3x æå‡                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å®ç°æ¨¡å¼

### æ¨¡å¼1: ç¼–è¯‘æ—¶è‡ªåŠ¨é€‰æ‹©

```cpp
template <typename MatrixT>
    requires AnySparse<MatrixT>
void algorithm(MatrixT& matrix, ...) {
    if constexpr (CustomSparseLike<MatrixT, true> || 
                  CustomSparseLike<MatrixT, false>) {
        // Fast path: ç›´æ¥è®¿é—®è¿ç»­æ•°æ®
        algorithm_fast(matrix, ...);
    } else {
        // Generic path: ä½¿ç”¨ç»Ÿä¸€è®¿é—®å™¨
        algorithm_generic(matrix, ...);
    }
}
```

### æ¨¡å¼2: æ˜¾å¼å¿«é€Ÿè·¯å¾„å‡½æ•°

```cpp
// Generic implementation
template <typename MatrixT>
    requires AnySparse<MatrixT>
void algorithm_generic(const MatrixT& matrix) {
    // ä½¿ç”¨ primary_values() ç­‰
}

// Fast path for contiguous data
template <typename MatrixT, bool IsCSR>
    requires CustomSparseLike<MatrixT, IsCSR>
void algorithm_fast(const MatrixT& matrix) {
    // ç›´æ¥è®¿é—® matrix.data, matrix.indptr
    // æ‰¹é‡SIMDæ“ä½œ
}
```

## å¿«é€Ÿè·¯å¾„ä¼˜åŠ¿

### 1. æ‰¹é‡SIMDæ“ä½œ

**Generic Path**:
```cpp
// é€è¡Œå¤„ç†
for (Index i = 0; i < primary_dim; ++i) {
    auto vals = primary_values(matrix, i);
    // SIMD on single row
    simd_process(vals.ptr, vals.size());
}
```

**Fast Path**:
```cpp
// æ•´ä¸ªdataæ•°ç»„æ‰¹é‡å¤„ç†
Index total_nnz = matrix.indptr[primary_dim];
simd_process_batch(matrix.data, total_nnz);
```

### 2. æ›´å¥½çš„ç¼“å­˜åˆ©ç”¨

**Generic Path**: 
- æ¯æ¬¡è°ƒç”¨ `primary_values()` æœ‰å‡½æ•°è°ƒç”¨å¼€é”€
- å¯èƒ½çš„è™šå‡½æ•°è°ƒç”¨ (ISparse)

**Fast Path**:
- ç›´æ¥æŒ‡é’ˆè®¿é—®
- ç¼–è¯‘å™¨æ›´å®¹æ˜“ä¼˜åŒ–
- é›¶é—´æ¥è°ƒç”¨

### 3. å†…å­˜è®¿é—®æ¨¡å¼

**Generic Path**:
```
è®¿é—®æ¨¡å¼: é€šè¿‡è®¿é—®å™¨ â†’ å¯èƒ½æœ‰é—´æ¥
```

**Fast Path**:
```
è®¿é—®æ¨¡å¼: ç›´æ¥æŒ‡é’ˆ â†’ é¡ºåºè®¿é—® â†’ é¢„å–å‹å¥½
```

## æ€§èƒ½å¯¹æ¯” (é¢„ä¼°)

| æ“ä½œ | Generic Path | Fast Path | æå‡ |
|------|-------------|-----------|------|
| æ ‡é‡ç¼©æ”¾ | åŸºå‡† | 2-3x | ç›´æ¥è®¿é—® |
| SIMDç¼©æ”¾ | åŸºå‡† | 1.5-2x | æ‰¹å¤„ç† |
| SpMV | åŸºå‡† | 1.2-1.5x | å±•å¼€+é¢„å– |
| å½’ä¸€åŒ– | åŸºå‡† | 2-3x | æ‰¹é‡æ“ä½œ |

## ä½•æ—¶ä½¿ç”¨å¿«é€Ÿè·¯å¾„

### âœ… åº”è¯¥ä½¿ç”¨å¿«é€Ÿè·¯å¾„

1. **çƒ­å¾ªç¯æ“ä½œ** - å¦‚ç¼©æ”¾ã€å½’ä¸€åŒ–
2. **å¯æ‰¹é‡å¤„ç†** - æ•´ä¸ªdataæ•°ç»„çš„æ“ä½œ
3. **å†…å­˜å¯†é›†å‹** - å—å†…å­˜å¸¦å®½é™åˆ¶çš„æ“ä½œ
4. **ç®€å•æ“ä½œ** - ä¸éœ€è¦å¤æ‚é€»è¾‘çš„æ“ä½œ

### âŒ ä¸éœ€è¦å¿«é€Ÿè·¯å¾„

1. **ç®—æ³•å¤æ‚** - å¦‚æ’åºã€æœç´¢(é€»è¾‘ä¸»å¯¼)
2. **å·²ç»å¾ˆå¿«** - å¦‚ç¨€ç–ç‚¹ç§¯(å·²ä¼˜åŒ–)
3. **é€šç”¨æ€§é‡è¦** - å¦‚ç»Ÿè®¡æµ‹è¯•(æ­£ç¡®æ€§ä¼˜å…ˆ)
4. **æ€§èƒ½å·®å¼‚å°** - æå‡<10%ä¸å€¼å¾—å¢åŠ å¤æ‚åº¦

## å½“å‰å®ç°çŠ¶æ€

### å·²å®ç°å¿«é€Ÿè·¯å¾„

- âœ… **normalize.hpp**: `scale_primary()` 
  - Fast path: æ‰¹é‡SIMDç¼©æ”¾æ•´ä¸ªdataæ•°ç»„
  - Generic path: é€è¡ŒSIMDç¼©æ”¾

- âœ… **algebra.hpp**: `spmv()`
  - Fast path: 4-wayå±•å¼€ + ç›´æ¥æŒ‡é’ˆè®¿é—®
  - Generic path: æ ‡å‡†ç‚¹ç§¯

### ä»…é€šç”¨è·¯å¾„(è¶³å¤Ÿå¿«)

- âœ… **group.hpp**: ç»„èšåˆ (é€»è¾‘ä¸»å¯¼,æ— éœ€å¿«é€Ÿè·¯å¾„)
- âœ… **mmd.hpp**: MMDè®¡ç®— (ç®—æ³•å¤æ‚,é€šç”¨å³å¯)
- âœ… **mwu.hpp**: ç§©æ£€éªŒ (æ’åºä¸»å¯¼,é€šç”¨å³å¯)
- âœ… **bbknn.hpp**: æ‰¹æ¬¡KNN (æœç´¢ç®—æ³•,é€šç”¨å³å¯)
- âœ… **log1p.hpp**: å¯¹æ•°å˜æ¢ (å·²SIMDä¼˜åŒ–,é€šç”¨å³å¯)

## æ€»ç»“

**å¹³è¡¡æŠ½è±¡ä¸æ€§èƒ½**:
- é»˜è®¤ä½¿ç”¨ç»Ÿä¸€æŠ½è±¡ (å‡å°‘ä»£ç é‡å¤)
- å…³é”®è·¯å¾„æä¾›å¿«é€Ÿå®ç° (ä¿è¯æ€§èƒ½)
- ç¼–è¯‘æ—¶è‡ªåŠ¨é€‰æ‹© (é›¶è¿è¡Œæ—¶å¼€é”€)

è¿™æ˜¯æœ€ä½³å®è·µ! ğŸ¯
