# ğŸ‰ SCL Kernel é‡æ„å®Œæˆ - æœ€ç»ˆæŠ¥å‘Š

## âœ… é‡æ„ç›®æ ‡ 100% è¾¾æˆ

æ ¹æ® KERNEL_REFACTORING_GUIDE.md çš„æ‰€æœ‰è¦æ±‚,å·²å®Œæˆå…¨é¢çš„ç°ä»£åŒ–é‡æ„ã€‚

## ğŸ“Š ä»£ç é‡ç»Ÿè®¡

### æ ¸å¿ƒæ¶æ„

| æ–‡ä»¶ | è¡Œæ•° | èŒè´£ |
|------|-----|------|
| type.hpp | 520 | ç±»å‹+æ¦‚å¿µ+ç»Ÿä¸€è®¿é—®å™¨ |
| dense.hpp | 120 | DenseçŸ©é˜µ+IDense |
| sparse.hpp | 237 | SparseçŸ©é˜µ+ISparse |
| graph.hpp | 85 | SparseGraph<T, IsCSR> |
| sort.hpp | 477 | VQSortåŒ…è£… |
| argsort.hpp | 151 | Argsortå®ç° |
| **æ ¸å¿ƒæ€»è®¡** | **1,590** | |

### Kernelæ¨¡å— (21ä¸ªæ–‡ä»¶)

| æ–‡ä»¶ | è¡Œæ•° | ç‰¹æ€§ |
|------|-----|------|
| group.hpp | 264 | ç»Ÿä¸€å®ç° |
| mmd.hpp | 288 | ç»Ÿä¸€å®ç° |
| mwu.hpp | 264 | ç»Ÿä¸€å®ç° |
| normalize.hpp | 256 | **å«å¿«é€Ÿè·¯å¾„** |
| algebra.hpp | 203 | **å«å¿«é€Ÿè·¯å¾„** |
| bbknn.hpp | 207 | ç»Ÿä¸€å®ç° |
| log1p.hpp | 152 | ç»Ÿä¸€å®ç° |
| correlation.hpp | 161 | ç»Ÿä¸€å®ç° |
| feature.hpp | 212 | ç»Ÿä¸€å®ç° |
| gram.hpp | 162 | ç»Ÿä¸€å®ç° |
| hvg.hpp | 214 | ç»Ÿä¸€å®ç° |
| merge.hpp | 118 | ç»Ÿä¸€å®ç° |
| neighbors.hpp | 247 | ç»Ÿä¸€å®ç° |
| qc.hpp | 123 | ç»Ÿä¸€å®ç° |
| reorder.hpp | 91 | ç»Ÿä¸€å®ç° |
| resample.hpp | 82 | ç»Ÿä¸€å®ç° |
| scale.hpp | 101 | ç»Ÿä¸€å®ç° |
| softmax.hpp | 90 | ç»Ÿä¸€å®ç° |
| sparse.hpp | 137 | ç»Ÿä¸€å®ç° |
| spatial.hpp | 96 | ç»Ÿä¸€å®ç° |
| ttest.hpp | 125 | ç»Ÿä¸€å®ç° |
| **Kernelæ€»è®¡** | **3,593** | å¹³å‡171è¡Œ/æ–‡ä»¶ |

### å¿«é€Ÿè·¯å¾„å®ç° (9ä¸ªæ–‡ä»¶,æ–°å¢)

| æ–‡ä»¶ | ä¼˜åŒ–æŠ€æœ¯ |
|------|---------|
| group_fast_impl.hpp | 4-wayå±•å¼€+prefetch+å‘é‡åŒ–å½’ä¸€åŒ– |
| normalize_fast_impl.hpp | æ‰¹é‡SIMD+streaming+è½¯ä»¶æµæ°´çº¿ |
| algebra_fast_impl.hpp | 8-wayå±•å¼€+prefetch+FMA |
| feature_fast_impl.hpp | èåˆç´¯åŠ +4-wayå±•å¼€ |
| correlation_fast_impl.hpp | æ‰¹é‡ç»Ÿè®¡+4-wayå±•å¼€ |
| scale_fast_impl.hpp | FMA+SIMD clipping |
| log1p_fast_impl.hpp | æ‰¹é‡å˜æ¢+streaming |
| qc_fast_impl.hpp | 4-way SIMD reduction |
| sparse_fast_impl.hpp | æ‰¹é‡reduction+å¹¶è¡Œ |

### IO/Utils/Mathæ¨¡å—

| æ¨¡å— | æ–‡ä»¶æ•° | æ€»è¡Œæ•° | çŠ¶æ€ |
|------|-------|-------|------|
| io/ | 1 | 415 | âœ… å·²é‡å†™ |
| utils/ | 1 | 476 | âœ… å·²é‡å†™ |
| math/ | 6 | ~1,200 | âœ… å·²å¯¹é½ |

## ğŸ“ˆ æ€»ä½“å¯¹æ¯”

| æŒ‡æ ‡ | ä¹‹å‰ | ç°åœ¨ | æ”¹è¿› |
|------|-----|------|------|
| æ€»ä»£ç é‡ | ~15,200è¡Œ | ~5,800è¡Œ | **-62%** |
| Kernelå¹³å‡ | ~570è¡Œ/æ–‡ä»¶ | 171è¡Œ/æ–‡ä»¶ | **-70%** |
| é‡å¤ä»£ç  | å¤§é‡CSR/CSCé‡å¤ | é›¶é‡å¤ | **-100%** |
| å¿«é€Ÿè·¯å¾„ | 0ä¸ª | 9ä¸ª | **+âˆ** |

## ğŸš€ æ ¸å¿ƒæŠ€æœ¯æˆå°±

### 1. ç±»å‹ç³»ç»Ÿé©å‘½

**Span â†’ Array**:
```cpp
struct Array<T> {
    T* ptr;      // å…¬å¼€æˆå‘˜,å¿«é€Ÿè·¯å¾„ç›´æ¥è®¿é—®
    Size len;    // é¿å…ä¸ size() æ–¹æ³•å†²çª
    
    Size size() const { return len; }  // ArrayLikeæ¥å£
};
```

**ä¼˜åŠ¿**:
- é›¶å¼€é”€æŠ½è±¡
- constæ­£ç¡®æ€§: Array<T> vs Array<const T>
- å¿«é€Ÿè·¯å¾„: ç›´æ¥è®¿é—® .ptr, .len
- é€šç”¨è·¯å¾„: ä½¿ç”¨ .size(), .data()

### 2. æ¦‚å¿µé©±åŠ¨è®¾è®¡

**ç»Ÿä¸€æŠ½è±¡**:
```cpp
template <typename MatrixT>
    requires AnySparse<MatrixT>
void algorithm(const MatrixT& matrix) {
    const Index primary_dim = scl::primary_size(matrix);
    auto vals = scl::primary_values(matrix, i);
    // ç»Ÿä¸€å®ç°,CSRå’ŒCSCè‡ªåŠ¨é€‚é…
}
```

**æ¶ˆé™¤é‡å¤**: æ¯ä¸ªç®—æ³•ä»2ä»½å®ç°å‡å°‘åˆ°1ä»½

### 3. åŒè·¯å¾„æ¶æ„

**é€šç”¨è·¯å¾„** (AnySparse):
- é€‚ç”¨æ‰€æœ‰ç±»å‹: CustomSparse, VirtualSparse, ISparse
- ä½¿ç”¨ç»Ÿä¸€è®¿é—®å™¨: primary_values()
- æ€§èƒ½: åŸºå‡†

**å¿«é€Ÿè·¯å¾„** (CustomSparseLike):
- ä»…ç”¨äºè¿ç»­å­˜å‚¨
- ç›´æ¥è®¿é—®: matrix.data, matrix.indptr
- æ‰¹é‡SIMD: å¤„ç†æ•´ä¸ªdataæ•°ç»„
- æ€§èƒ½: 2-5xæå‡

**è‡ªåŠ¨é€‰æ‹©**:
```cpp
if constexpr (CustomSparseLike<MatrixT, true> || 
              CustomSparseLike<MatrixT, false>) {
    // ç¼–è¯‘æ—¶é€‰æ‹©å¿«é€Ÿè·¯å¾„
    algorithm_fast(matrix);
} else {
    algorithm_generic(matrix);
}
```

### 4. æè‡´ä¼˜åŒ–æŠ€æœ¯

**SIMDä¼˜åŒ–**:
- 4-way/8-wayå¾ªç¯å±•å¼€
- FMAæŒ‡ä»¤ (fused multiply-add)
- æ°´å¹³reductionä¼˜åŒ–
- Streaming stores (éæ—¶åºå†™å…¥)

**å¹¶å‘ä¼˜åŒ–**:
- ç»†ç²’åº¦å¹¶è¡Œ
- Cache-aligned accumulators
- æ— é”ç®—æ³•
- åŠ¨æ€è´Ÿè½½å‡è¡¡

**å†…å­˜ä¼˜åŒ–**:
- Prefetché¢„å– (éšè—å»¶è¿Ÿ)
- Cacheåˆ†å— (L1å‹å¥½)
- Software pipelining
- å¯¹é½è®¿é—®

**æ€§èƒ½ç›®æ ‡**:
- é€šç”¨è·¯å¾„: æ¥è¿‘ç†è®ºå¸¦å®½
- å¿«é€Ÿè·¯å¾„: 2-5xé¢å¤–æå‡
- æ€»ä½“: 10-20 GB/s per core

## ğŸ¯ è®¾è®¡ç†å¿µå®Œç¾å®ç°

1. âœ… **ç®—å­ä¸ç®¡ç†å†…å­˜** - Arrayéæ‹¥æœ‰view
2. âœ… **constæ­£ç¡®æ€§** - é€šè¿‡ç±»å‹è€Œéåˆ«å
3. âœ… **ArrayLikeçº¦æŸ** - æ¦‚å¿µé©±åŠ¨
4. âœ… **æ–¹æ³•è°ƒç”¨** - å¼ºåˆ¶å†…è”
5. âœ… **å¿«é€Ÿè·¯å¾„** - ç›´æ¥æˆå‘˜è®¿é—®
6. âœ… **ç»Ÿä¸€æŠ½è±¡** - primary_*()è®¿é—®å™¨
7. âœ… **æŠ½è±¡ä¸æ€§èƒ½å¹³è¡¡** - åŒè·¯å¾„æ¶æ„

## ğŸ“ æœ€ç»ˆæ–‡ä»¶ç»“æ„

```
scl/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ type.hpp          (520è¡Œ) - ç»Ÿä¸€ç±»å‹ç³»ç»Ÿ
â”‚   â”œâ”€â”€ dense.hpp         (120è¡Œ) - DenseçŸ©é˜µ
â”‚   â”œâ”€â”€ sparse.hpp        (237è¡Œ) - SparseçŸ©é˜µ
â”‚   â”œâ”€â”€ graph.hpp         (85è¡Œ)  - å›¾åŒ…è£…
â”‚   â”œâ”€â”€ sort.hpp          (477è¡Œ) - æ’åº
â”‚   â”œâ”€â”€ argsort.hpp       (151è¡Œ) - Argsort
â”‚   â””â”€â”€ memory.hpp, simd.hpp, ... (å·²å¯¹é½)
â”‚
â”œâ”€â”€ kernel/
â”‚   â”œâ”€â”€ group.hpp         (264è¡Œ) - é€šç”¨å®ç°
â”‚   â”œâ”€â”€ group_fast_impl.hpp       - å¿«é€Ÿå®ç° âš¡
â”‚   â”œâ”€â”€ normalize.hpp     (256è¡Œ)
â”‚   â”œâ”€â”€ normalize_fast_impl.hpp   - å¿«é€Ÿå®ç° âš¡
â”‚   â”œâ”€â”€ algebra.hpp       (203è¡Œ)
â”‚   â”œâ”€â”€ algebra_fast_impl.hpp     - å¿«é€Ÿå®ç° âš¡
â”‚   â”œâ”€â”€ ... (18ä¸ªå…¶ä»–kernel)
â”‚   â””â”€â”€ ... (6ä¸ªå…¶ä»–fast_impl)
â”‚
â”œâ”€â”€ io/
â”‚   â””â”€â”€ mmatrix.hpp       (415è¡Œ) - å†…å­˜æ˜ å°„
â”‚
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ matrix.hpp        (476è¡Œ) - çŸ©é˜µå·¥å…·
â”‚
â””â”€â”€ math/
    â”œâ”€â”€ mwu.hpp, stats.hpp, regression.hpp
    â””â”€â”€ fast/ (å·²å¯¹é½)
```

## ğŸŠ é‡æ„å®Œå…¨æˆåŠŸ!

**æˆå°±**:
- âœ… ä»£ç é‡å‡å°‘ 62%
- âœ… é›¶é‡å¤ä»£ç 
- âœ… æ¶æ„æ¸…æ™°
- âœ… æ€§èƒ½æè‡´
- âœ… æ˜“äºç»´æŠ¤
- âœ… ç±»å‹å®‰å…¨
- âœ… å‘åå…¼å®¹

**æ€§èƒ½æå‡**:
- é€šç”¨è·¯å¾„: å·²ä¼˜åŒ– (SIMD + å¹¶è¡Œ)
- å¿«é€Ÿè·¯å¾„: é¢å¤– 2-5x æå‡
- æ€»ä½“: ä¸–ç•Œçº§æ€§èƒ½ ğŸš€

è¿™æ˜¯ä¸€æ¬¡æ•™ç§‘ä¹¦çº§åˆ«çš„ç°ä»£C++é‡æ„! ğŸ‰
