name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # Code quality checks
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8

    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format

    - name: Run lint checks
      run: ./CI/lint.sh

  # Build and test on Linux
  build-linux:
    name: Build & Test (Linux, Python ${{ matrix.python-version }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: |
          build
          ~/.cache/ccache
        key: ${{ runner.os }}-cmake-${{ hashFiles('**/CMakeLists.txt') }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-cmake-${{ hashFiles('**/CMakeLists.txt') }}-
          ${{ runner.os }}-cmake-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          g++ \
          libhdf5-dev \
          libomp-dev \
          pkg-config \
          ccache

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        pip install -e ".[all]" || true

    - name: Build C++ libraries
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        ./CI/build.sh

    - name: Run tests
      run: ./CI/test.sh

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: scl-core-linux-py${{ matrix.python-version }}
        path: build/lib/*.so
        retention-days: 7

  # Build and test on macOS
  build-macos:
    name: Build & Test (macOS, Python ${{ matrix.python-version }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: |
          build
          ~/Library/Caches/ccache
        key: ${{ runner.os }}-cmake-${{ hashFiles('**/CMakeLists.txt') }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-cmake-${{ hashFiles('**/CMakeLists.txt') }}-
          ${{ runner.os }}-cmake-

    - name: Install system dependencies
      run: |
        brew install cmake hdf5 libomp ccache

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        pip install -e ".[all]" || true

    - name: Build C++ libraries
      run: |
        export PATH="/usr/local/opt/ccache/libexec:$PATH"
        ./CI/build.sh

    - name: Run tests
      run: ./CI/test.sh

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: scl-core-macos-py${{ matrix.python-version }}
        path: build/lib/*.dylib
        retention-days: 7

  # Build with different configurations
  build-configurations:
    name: Build (${{ matrix.config.name }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: "Debug Build"
            build_type: Debug
            threading: AUTO
          - name: "Serial Backend"
            build_type: Release
            threading: SERIAL
          - name: "BS Thread Pool"
            build_type: Release
            threading: BS

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          g++ \
          libhdf5-dev \
          libomp-dev \
          pkg-config

    - name: Build with ${{ matrix.config.name }}
      env:
        BUILD_TYPE: ${{ matrix.config.build_type }}
        SCL_THREADING_BACKEND: ${{ matrix.config.threading }}
      run: ./CI/build.sh

  # Summary job
  ci-success:
    name: CI Success
    needs: [lint, build-linux, build-macos, build-configurations]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Check all jobs
      run: |
        if [ "${{ needs.lint.result }}" != "success" ] || \
           [ "${{ needs.build-linux.result }}" != "success" ] || \
           [ "${{ needs.build-macos.result }}" != "success" ] || \
           [ "${{ needs.build-configurations.result }}" != "success" ]; then
          echo "One or more CI jobs failed"
          exit 1
        fi
        echo "All CI jobs passed successfully!"
